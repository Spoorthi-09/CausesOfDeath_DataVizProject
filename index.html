<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Map with D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        path {
            fill: none;
            stroke: #333;
            stroke-width: 0.5;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            pointer-events: none;
            font-size: 14px;
            display: none;
        }

        #year-dropdown {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>
<body>
    <svg id="world-map" width="960" height="950"></svg>

    <div class="tooltip" id="tooltip"></div>

    <div id="year-dropdown">
        <select id="year-select"></select>
    </div>

    <script>
        const svg = d3.select("#world-map");
        const yearSelect = d3.select("#year-select");

        //defining projection for the map
        const projection = d3.geoMercator()
            .scale(150)
            .translate([svg.attr("width") / 2, svg.attr("height") / 2]);

        //creating a path generator
        const path = d3.geoPath().projection(projection);

        //to load and display the GeoJSON data
        d3.json("world.geojson").then(function (worldData) {
            //to load the CSV data
            d3.csv("deaths_gdp_obesity_sorted.csv").then(function (csvData) {
                //to get the unique years from the dataset
                const years = [...new Set(csvData.map(d => d.Year))];

                //populating the dropdown with years
                yearSelect.selectAll("option")
                    .data(years)
                    .enter()
                    .append("option")
                    .attr("value", d => d)
                    .text(d => d);

                //setting the default value of the dropdown to "1990"
                yearSelect.property("value", "1990");

                //Function to update the map based on the selected year
                function updateMap() {
                    const selectedYear = yearSelect.property("value");

                    //defining a color scale for the selected year
                    const maxTotalDeaths = d3.max(csvData, data => data.Year === selectedYear ? +data.total_deaths : 0);
                    const colorScale = d3.scaleSequential(d3.interpolateReds)
                        .domain([0, maxTotalDeaths]);

                    //updating the map color coding and returning none for countries with missing data
                    svg.selectAll("path")
                        .style("fill", function (d) {
                            const countryName = d.properties.name;
                            const countryData = csvData.find(data => data['Country/Territory'] === countryName && data.Year === selectedYear);
                            if (countryData) {
                                return colorScale(+countryData.total_deaths);
                            }
                            return "none"; 
                        });
                }

                //Function to show tooltips on hover
                function showTooltip(event, d) {
                    const countryName = d['properties']['name'];
                    const selectedYear = yearSelect.property("value");
                    const countryData = csvData.find(data => data['Country/Territory'] === countryName && data['Year'] === selectedYear);
                    if (countryData) {
                        const totalDeaths = +countryData.total_deaths;
                        const [x, y] = d3.pointer(event);
                        d3.select("#tooltip")
                            .style("left", x + "px")
                            .style("top", y + "px")
                            .html(`<strong>${countryName}</strong><br>Total Deaths: ${totalDeaths}`)
                            .style("display", "block");
                    }
                }

                //Function to hide tooltips on mouseout
                function hideTooltip() {
                    d3.select("#tooltip").style("display", "none");
                }

                function handleCountryClick() {
                    const countryName = this.getAttribute("data-country-name");
                    console.log(countryName);
                    window.location.href = `countryGraph.html?country=${countryName}`;
                }

                //to draw the map with countries color-coded by total deaths, tooltips, and click handling
                svg.selectAll("path")
                    .data(worldData.features)
                    .enter()
                    .append("path")
                    .attr("data-country-name", d => d['properties']['name'])
                    .attr("d", path)
                    .on("mouseover", showTooltip)
                    .on("mouseout", hideTooltip)
                    .on("click", handleCountryClick);

                //Initial map color coding
                yearSelect.on("change", updateMap);
                updateMap(); // Initialize the map with the default year
            });
        });
    </script>
</body>
</html>
